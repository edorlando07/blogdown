---
title: "Building a Spotify Recommendation Model With R"
author: "Ed Orlando"
date: 2020-05-18
categories: ["R"]
tags: ["R Markdown", "tidyverse", "plotly", "recommenderlab", "arules", "arulesViz"]
description: "This blog walks viewers through how to create a playlist recommendation algorithm using recommenderlab and arules packages"

params:
    interactive: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    collapse = TRUE,
    out.width = "100%")
```

### Author: Ed Orlando

<br>

### Problem Statement

This tutorial shows you how to create a Spotify Recommendation Algorithm using the **recommenderlab()** and **arules()** packages. 

<br>

### Load Libraries
To get started, first load the libbraries listed below.

```{r, echo=TRUE, results="hide", warning=FALSE, error=FALSE, message=FALSE}
# Core & Viz
library(tidyverse)
library(tidyquant)
library(plotly)

# Modeling
library(recommenderlab)
library(arules)
#library(arulesViz)
```

<br>

### Load Data
The data was previously downloaded using **[Exportify](<https://rawgit.com/watsonbox/exportify/master/exportify.html>)**.  There were 27 various genres included and each genre has 10-60 various playlists included.  We will analyze more of this detail later, but first, let's load the data. 


```{r, warning=FALSE, error=FALSE, message=FALSE}
playlist_tbl <- read_csv2("Data_Sources/2020_05_20_Spotify_Playlist_Data/all_playlists.csv")
```

<br>

### Viewing the Data

The data consists of **~103K songs** and **18 variables**. You may view the .csv file **[here](https://ed-orlando07.netlify.app/zip_files/Spotify_Playlist.zip)**.  The features included in the data set are listed below.  

Additional columns, including the genre, playlist, artist/track name concatenation were all previously engineered.  For more information related to engineering these columns, please visit my previous post **[here](<https://ed-orlando07.netlify.app/2020/05/14/loading-multiple-files-from-various-folders-in-r/>)**.  

```{r}
playlist_tbl %>% glimpse()
```

<br>

### Which Genres Have the Most Playlists?

Next, we can view which genre's have the highest number of playlists in the data file using **ggplot2()**.  

```{r, warning=FALSE, error=FALSE, message=FALSE, out.height="600px"}
genre_frequency_tbl <- playlist_tbl %>%
    count(genre) %>%
    arrange(desc(n)) %>%
    rowid_to_column(var = "rank")

g_00 <- genre_frequency_tbl %>%
    ggplot2::ggplot(aes(x = reorder(genre, n), 
                           y    = n, 
                           fill = n)) +
    geom_bar(stat = "identity",
             show.legend = FALSE) +
    scale_fill_gradient2(low="#000000", mid="#000000", high="#000000") +
    coord_flip() +
    theme_tq() +
    scale_color_tq() +
    theme(legend.direction = "vertical", 
          legend.position  = "right",
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color="#000000"),
          axis.text.y  = element_text(color="#000000"),
          axis.title.x = element_blank(),
          axis.title.y = element_blank()) + 
    labs(title = "Genre Song Frequency")

g_00

```

### Which Songs Are the Most Frequent?

We can also see which songs appear the most in multiple playlists.

```{r, warning=FALSE, error=FALSE, message=FALSE}
song_frequency_tbl <- playlist_tbl %>%
    count(artist_name, track_name, artist_track_name) %>%
    arrange(desc(n)) %>%
    rowid_to_column(var = "rank")

g_01 <- song_frequency_tbl %>%
    filter(rank <= 10) %>% 
    ggplot(aes(x = reorder(artist_track_name, n), 
                           y    = n, 
                           fill = n)) +
    geom_bar(stat = "identity",
             show.legend = FALSE) +
    scale_fill_gradient2(low="#000000", mid="#000000", high="#000000") +
    coord_flip() +
    theme_tq() +
    scale_color_tq() +
    theme(legend.direction = "vertical", 
          legend.position  = "right",
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color="#000000"),
          axis.text.y  = element_text(color="#000000"),
          axis.title.x = element_blank(),
          axis.title.y = element_blank()) + 
    labs(title = "Top 10 Artist/Track Names")

g_01

```

### Condense the Number of Songs in Tibble

In order for the Recommendation algorithm to run more efficiently, we can reduce the number of songs that do not appear at least 3 times.    

```{r}
playlist_condensed_tbl <- playlist_tbl %>%
    left_join(song_frequency_tbl) %>%
    filter(n >= 3) %>%
    select(source_playlist_id, artist_track_name) %>%
    distinct() %>%
    mutate(value = 1) %>%
    spread(artist_track_name, value, fill = 0)

playlist_song_rlab <- playlist_condensed_tbl %>%
    select(-source_playlist_id) %>%
    as.matrix() %>%
    as("binaryRatingMatrix")
    
```

```{r}
# eval_recipe <- playlist_song_rlab %>%
#     evaluationScheme(method = "cross-validation", k = 5, given = -1)
# 
# eval_recipe
```


```{r}
# algorithms_list <- list(
#     "association rules1"  = list(name  = "AR",
#                                    param = list(supp = 0.003, conf = 0.70)),
#     "association rules2"  = list(name  = "AR",
#                                    param = list(supp = 0.003, conf = 0.75)),
#     "association rules3"  = list(name  = "AR",
#                                   param = list(supp = 0.004, conf = 0.70)),
#     "association rules4"  = list(name  = "AR",
#                                   param = list(supp = 0.004, conf = 0.75))
#  )
```


```{r}
# !!! WARNING - This section is commented out since it is a long-running script !!!

# results_rlab_arules <- eval_recipe %>%
#     recommenderlab::evaluate(
#          method    = algorithms_list,
#          type      = "topNList",
#          n         = 1:10)
```


```{r}

# saveRDS(results_rlab_arules, file = "Models/results_arules.rds")

results_rlab_arules <- read_rds("Models/results_arules.rds")

# plot(results_rlab_arules, annotate = TRUE)

arules01_tbl <- results_rlab_arules$`association rules1`@results[[1]]@cm %>% 
    as_tibble() %>% 
    mutate(arules_model = "arules_model_01")
    
arules02_tbl <- results_rlab_arules$`association rules2`@results[[1]]@cm %>%
    as_tibble() %>% 
    mutate(arules_model = "arules_model_02")
    
arules03_tbl <- results_rlab_arules$`association rules3`@results[[1]]@cm %>%
    as_tibble() %>% 
    mutate(arules_model = "arules_model_03")
    
arules04_tbl <- results_rlab_arules$`association rules4`@results[[1]]@cm %>%
    as_tibble() %>% 
    mutate(arules_model = "arules_model_04")

arules_combined_tbl <- rbind(arules01_tbl, arules02_tbl, arules03_tbl, arules04_tbl)

arules_combined_tbl %>% glimpse()
```

```{r}
arules_combined_tbl %>% 
    ggplot(aes(x=FPR, y=TPR, group=arules_model, color=arules_model)) +
    geom_line(size = 1) +
    theme_minimal() +
    
    scale_colour_manual(values = c("#000000", "#808080", "#F08080", "#DC143C")) +
    
    #scale_color_tq() +
    theme(legend.direction = "vertical", 
          legend.position  = "right",
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color="#000000"),
          axis.text.y  = element_text(color="#000000")) +
    labs(title = "A Rules Model Comprarisons")
```




