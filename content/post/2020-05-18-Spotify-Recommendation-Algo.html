---
title: "Building a Spotify Recommendation Model With R"
author: "Ed Orlando"
date: 2020-05-18
categories: ["R"]
tags: ["R Markdown", "tidyverse", "plotly", "recommenderlab", "arules", "arulesViz"]
description: "This blog walks viewers through how to create a playlist recommendation algorithm using recommenderlab and arules packages"

params:
    interactive: TRUE
---



<div id="author-ed-orlando" class="section level3">
<h3>Author: Ed Orlando</h3>
<p><br></p>
</div>
<div id="problem-statement" class="section level3">
<h3>Problem Statement</h3>
<p>This tutorial shows you how to create a Spotify Recommendation Algorithm using the <strong>recommenderlab()</strong> and <strong>arules()</strong> packages.</p>
<p><br></p>
</div>
<div id="load-libraries" class="section level3">
<h3>Load Libraries</h3>
<p>To get started, first load the libbraries listed below.</p>
<pre class="r"><code># Core &amp; Viz
library(tidyverse)
library(tidyquant)
library(plotly)

# Modeling
library(recommenderlab)
library(arules)
#library(arulesViz)</code></pre>
<p><br></p>
</div>
<div id="load-data" class="section level3">
<h3>Load Data</h3>
<p>The data was previously downloaded using <strong><a href="https://rawgit.com/watsonbox/exportify/master/exportify.html">Exportify</a></strong>. There were 27 various genres included and each genre has 10-60 various playlists included. We will analyze more of this detail later, but first, let’s load the data.</p>
<pre class="r"><code>playlist_tbl &lt;- read_csv2(&quot;Data_Sources/2020_05_20_Spotify_Playlist_Data/all_playlists.csv&quot;)</code></pre>
<p><br></p>
</div>
<div id="viewing-the-data" class="section level3">
<h3>Viewing the Data</h3>
<p>The data consists of <strong>~103K songs</strong> and <strong>18 variables</strong>. You may view the .csv file <strong><a href="https://ed-orlando07.netlify.app/zip_files/Spotify_Playlist.zip">here</a></strong>. The features included in the data set are listed below.</p>
<p>Additional columns, including the genre, playlist, artist/track name concatenation were all previously engineered. For more information related to engineering these columns, please visit my previous post <strong><a href="https://ed-orlando07.netlify.app/2020/05/14/loading-multiple-files-from-various-folders-in-r/">here</a></strong>.</p>
<pre class="r"><code>playlist_tbl %&gt;% glimpse()
## Observations: 103,517
## Variables: 18
## $ spotify_uri           &lt;chr&gt; &quot;spotify:track:7EFnbc7UnvOyFcb6IhJq9v&quot;, &quot;spot...
## $ track_name            &lt;chr&gt; &quot;Oreke&quot;, &quot;Know Your Worth&quot;, &quot;Don&#39;t Rush (feat...
## $ artist_name           &lt;chr&gt; &quot;E Kelly, Joeboy&quot;, &quot;Khalid, Disclosure, DaVid...
## $ album_name            &lt;chr&gt; &quot;No Secrets&quot;, &quot;Know Your Worth&quot;, &quot;Don&#39;t Rush ...
## $ disc_number           &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
## $ track_number          &lt;dbl&gt; 3, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, ...
## $ `track_duration_(ms)` &lt;dbl&gt; 182639, 191067, 207640, 164571, 176962, 19609...
## $ added_by              &lt;chr&gt; &quot;spotify:user:&quot;, &quot;spotify:user:&quot;, &quot;spotify:us...
## $ added_at              &lt;dttm&gt; 2020-05-07 21:59:00, 2020-04-24 07:33:23, 20...
## $ playlist_name         &lt;chr&gt; &quot;african_heat&quot;, &quot;african_heat&quot;, &quot;african_heat...
## $ filename              &lt;chr&gt; &quot;./00_Data_Sources/Genres_Moods/Afro/african_...
## $ dot                   &lt;chr&gt; &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, &quot;.&quot;, ...
## $ folder_01             &lt;chr&gt; &quot;00_Data_Sources&quot;, &quot;00_Data_Sources&quot;, &quot;00_Dat...
## $ folder_02             &lt;chr&gt; &quot;Genres_Moods&quot;, &quot;Genres_Moods&quot;, &quot;Genres_Moods...
## $ genre                 &lt;chr&gt; &quot;Afro&quot;, &quot;Afro&quot;, &quot;Afro&quot;, &quot;Afro&quot;, &quot;Afro&quot;, &quot;Afro...
## $ playlist              &lt;chr&gt; &quot;african_heat.csv&quot;, &quot;african_heat.csv&quot;, &quot;afri...
## $ artist_track_name     &lt;chr&gt; &quot;E Kelly, Joeboy ||| Oreke&quot;, &quot;Khalid, Disclos...
## $ source_playlist_id    &lt;chr&gt; &quot;Afro_african_heat&quot;, &quot;Afro_african_heat&quot;, &quot;Af...</code></pre>
<p><br></p>
</div>
<div id="which-genres-have-the-most-playlists" class="section level3">
<h3>Which Genres Have the Most Playlists?</h3>
<p>Next, we can view which genre’s have the highest number of playlists in the data file using <strong>ggplot2()</strong>.</p>
<pre class="r"><code>genre_frequency_tbl &lt;- playlist_tbl %&gt;%
    count(genre) %&gt;%
    arrange(desc(n)) %&gt;%
    rowid_to_column(var = &quot;rank&quot;)

g_00 &lt;- genre_frequency_tbl %&gt;%
    ggplot2::ggplot(aes(x = reorder(genre, n), 
                           y    = n, 
                           fill = n)) +
    geom_bar(stat = &quot;identity&quot;,
             show.legend = FALSE) +
    scale_fill_gradient2(low=&quot;#000000&quot;, mid=&quot;#000000&quot;, high=&quot;#000000&quot;) +
    coord_flip() +
    theme_tq() +
    scale_color_tq() +
    theme(legend.direction = &quot;vertical&quot;, 
          legend.position  = &quot;right&quot;,
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color=&quot;#000000&quot;),
          axis.text.y  = element_text(color=&quot;#000000&quot;),
          axis.title.x = element_blank(),
          axis.title.y = element_blank()) + 
    labs(title = &quot;Genre Song Frequency&quot;)

g_00</code></pre>
<p><img src="/post/2020-05-18-Spotify-Recommendation-Algo_files/figure-html/unnamed-chunk-4-1.png" width="100%" height="600px" /></p>
</div>
<div id="which-songs-are-the-most-frequent" class="section level3">
<h3>Which Songs Are the Most Frequent?</h3>
<p>We can also see which songs appear the most in multiple playlists.</p>
<pre class="r"><code>song_frequency_tbl &lt;- playlist_tbl %&gt;%
    count(artist_name, track_name, artist_track_name) %&gt;%
    arrange(desc(n)) %&gt;%
    rowid_to_column(var = &quot;rank&quot;)

g_01 &lt;- song_frequency_tbl %&gt;%
    filter(rank &lt;= 10) %&gt;% 
    ggplot(aes(x = reorder(artist_track_name, n), 
                           y    = n, 
                           fill = n)) +
    geom_bar(stat = &quot;identity&quot;,
             show.legend = FALSE) +
    scale_fill_gradient2(low=&quot;#000000&quot;, mid=&quot;#000000&quot;, high=&quot;#000000&quot;) +
    coord_flip() +
    theme_tq() +
    scale_color_tq() +
    theme(legend.direction = &quot;vertical&quot;, 
          legend.position  = &quot;right&quot;,
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color=&quot;#000000&quot;),
          axis.text.y  = element_text(color=&quot;#000000&quot;),
          axis.title.x = element_blank(),
          axis.title.y = element_blank()) + 
    labs(title = &quot;Top 10 Artist/Track Names&quot;)

g_01</code></pre>
<p><img src="/post/2020-05-18-Spotify-Recommendation-Algo_files/figure-html/unnamed-chunk-5-1.png" width="100%" /></p>
</div>
<div id="condense-the-number-of-songs-in-tibble" class="section level3">
<h3>Condense the Number of Songs in Tibble</h3>
<p>In order for the Recommendation algorithm to run more efficiently, we can reduce the number of songs that do not appear at least 3 times.</p>
<pre class="r"><code>playlist_condensed_tbl &lt;- playlist_tbl %&gt;%
    left_join(song_frequency_tbl) %&gt;%
    filter(n &gt;= 3) %&gt;%
    select(source_playlist_id, artist_track_name) %&gt;%
    distinct() %&gt;%
    mutate(value = 1) %&gt;%
    spread(artist_track_name, value, fill = 0)
## Joining, by = c(&quot;track_name&quot;, &quot;artist_name&quot;, &quot;artist_track_name&quot;)

playlist_song_rlab &lt;- playlist_condensed_tbl %&gt;%
    select(-source_playlist_id) %&gt;%
    as.matrix() %&gt;%
    as(&quot;binaryRatingMatrix&quot;)
    </code></pre>
<pre class="r"><code># eval_recipe &lt;- playlist_song_rlab %&gt;%
#     evaluationScheme(method = &quot;cross-validation&quot;, k = 5, given = -1)
# 
# eval_recipe</code></pre>
<pre class="r"><code># algorithms_list &lt;- list(
#     &quot;association rules1&quot;  = list(name  = &quot;AR&quot;,
#                                    param = list(supp = 0.003, conf = 0.70)),
#     &quot;association rules2&quot;  = list(name  = &quot;AR&quot;,
#                                    param = list(supp = 0.003, conf = 0.75)),
#     &quot;association rules3&quot;  = list(name  = &quot;AR&quot;,
#                                   param = list(supp = 0.004, conf = 0.70)),
#     &quot;association rules4&quot;  = list(name  = &quot;AR&quot;,
#                                   param = list(supp = 0.004, conf = 0.75))
#  )</code></pre>
<pre class="r"><code># !!! WARNING - This section is commented out since it is a long-running script !!!

# results_rlab_arules &lt;- eval_recipe %&gt;%
#     recommenderlab::evaluate(
#          method    = algorithms_list,
#          type      = &quot;topNList&quot;,
#          n         = 1:10)</code></pre>
<pre class="r"><code>
# saveRDS(results_rlab_arules, file = &quot;Models/results_arules.rds&quot;)

results_rlab_arules &lt;- read_rds(&quot;Models/results_arules.rds&quot;)

# plot(results_rlab_arules, annotate = TRUE)

arules01_tbl &lt;- results_rlab_arules$`association rules1`@results[[1]]@cm %&gt;% 
    as_tibble() %&gt;% 
    mutate(arules_model = &quot;arules_model_01&quot;)
    
arules02_tbl &lt;- results_rlab_arules$`association rules2`@results[[1]]@cm %&gt;%
    as_tibble() %&gt;% 
    mutate(arules_model = &quot;arules_model_02&quot;)
    
arules03_tbl &lt;- results_rlab_arules$`association rules3`@results[[1]]@cm %&gt;%
    as_tibble() %&gt;% 
    mutate(arules_model = &quot;arules_model_03&quot;)
    
arules04_tbl &lt;- results_rlab_arules$`association rules4`@results[[1]]@cm %&gt;%
    as_tibble() %&gt;% 
    mutate(arules_model = &quot;arules_model_04&quot;)

arules_combined_tbl &lt;- rbind(arules01_tbl, arules02_tbl, arules03_tbl, arules04_tbl)

arules_combined_tbl %&gt;% glimpse()
## Observations: 40
## Variables: 9
## $ TP           &lt;dbl&gt; 0.008333333, 0.012500000, 0.016666667, 0.016666667, 0....
## $ FP           &lt;dbl&gt; 0.5708333, 1.1125000, 1.6166667, 2.1041667, 2.5666667,...
## $ FN           &lt;dbl&gt; 0.9916667, 0.9875000, 0.9833333, 0.9833333, 0.9833333,...
## $ TN           &lt;dbl&gt; 7990.429, 7989.887, 7989.383, 7988.896, 7988.433, 7988...
## $ precision    &lt;dbl&gt; 0.014388489, 0.010791367, 0.009592326, 0.007194245, 0....
## $ recall       &lt;dbl&gt; 0.008333333, 0.012500000, 0.016666667, 0.016666667, 0....
## $ TPR          &lt;dbl&gt; 0.008333333, 0.012500000, 0.016666667, 0.016666667, 0....
## $ FPR          &lt;dbl&gt; 7.143453e-05, 1.392191e-04, 2.023109e-04, 2.633171e-04...
## $ arules_model &lt;chr&gt; &quot;arules_model_01&quot;, &quot;arules_model_01&quot;, &quot;arules_model_01...</code></pre>
<pre class="r"><code>arules_combined_tbl %&gt;% 
    ggplot(aes(x=FPR, y=TPR, group=arules_model, color=arules_model)) +
    geom_line(size = 1) +
    theme_minimal() +
    
    scale_colour_manual(values = c(&quot;#000000&quot;, &quot;#808080&quot;, &quot;#F08080&quot;, &quot;#DC143C&quot;)) +
    
    #scale_color_tq() +
    theme(legend.direction = &quot;vertical&quot;, 
          legend.position  = &quot;right&quot;,
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.text.x  = element_text(color=&quot;#000000&quot;),
          axis.text.y  = element_text(color=&quot;#000000&quot;)) +
    labs(title = &quot;A Rules Model Comprarisons&quot;)</code></pre>
<p><img src="/post/2020-05-18-Spotify-Recommendation-Algo_files/figure-html/unnamed-chunk-11-1.png" width="100%" /></p>
</div>
